{% extends "base.html" %}
{% block content %}
<h1 class="mb-4">Print Stickers</h1>
<form method="POST" action="">
    {{ form.hidden_tag() }}
    <div class="form-group">
        {{ form.product_id.label(class="form-label") }}
        {{ form.product_id(class="form-control") }}
    </div>
    <div class="form-group">
        {{ form.mfg_date.label(class="form-label") }}
        {{ form.mfg_date(class="form-control", onclick="this.showPicker()") }}
    </div>
    <div class="form-group">
        {{ form.exp_date.label(class="form-label") }}
        {{ form.exp_date(class="form-control", onclick="this.showPicker()") }}
    </div>
    <div class="form-group">
        {{ form.quantity.label(class="form-label") }}
        {{ form.quantity(class="form-control") }}
    </div>
    <div class="form-group">
        {{ form.submit(class="btn btn-primary") }}
    </div>
</form>

<script type="text/javascript">
document.addEventListener('DOMContentLoaded', (event) => {
    const productSelect = document.querySelector('#product_id');
    const shelfLifeMapping = {};

    // Fetch the shelf life data for each product
    fetch('/products')
        .then(response => response.json())
        .then(data => {
            data.forEach(product => {
                shelfLifeMapping[product.id] = product.shelf_life;
            });
        });

    const mfgDateField = document.querySelector('#mfg_date');
    const expDateField = document.querySelector('#exp_date');

    // Set manufacturing date to today's date
    const today = new Date().toISOString().split('T')[0];
    mfgDateField.value = today;

    const calculateExpDate = () => {
        const selectedProductId = productSelect.value;
        const shelfLife = shelfLifeMapping[selectedProductId];
        const mfgDate = new Date(mfgDateField.value);

        if (shelfLife) {
            const expDate = new Date(mfgDate.getTime() + (shelfLife * 24 * 60 * 60 * 1000));
            expDateField.value = expDate.toISOString().split('T')[0];
        }
    };

    // Calculate expiry date when product is selected or mfg date input is changed
    productSelect.addEventListener('change', calculateExpDate);
    mfgDateField.addEventListener('change', calculateExpDate);
    mfgDateField.addEventListener('input', calculateExpDate);
});
</script>
{% endblock %}
